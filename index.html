<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Shutoff Dashboard</title>
    <link rel="icon" type="image/png" href="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { navy: '#152a40', red: '#bf2726', yellow: '#f9c031' } } } }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot,
            getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1iKuBTPQLULOnEHISUEoU62nAi_h2nPA",
            authDomain: "denton-fire-tools.firebaseapp.com",
            projectId: "denton-fire-tools",
            storageBucket: "denton-fire-tools.firebasestorage.app",
            messagingSenderId: "751121603550",
            appId: "1:751121603550:web:3a8f25b990d45038ae1b4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'denton-fire-tools';

        let map;

        // Login & Session
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('denton_admin_session') === 'active') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard-view').classList.remove('hidden');
                connectFirebase();
            }
        });

        window.checkLogin = () => {
            if (document.getElementById('admin-pass').value === "FDADMIN") {
                localStorage.setItem('denton_admin_session', 'active');
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard-view').classList.remove('hidden');
                connectFirebase();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.performLogout = () => {
            localStorage.removeItem('denton_admin_session');
            signOut(auth).then(() => location.reload());
        };

        const connectFirebase = () => {
            signInAnonymously(auth);
            onAuthStateChanged(auth, user => {
                if (user) {
                    initMap();
                    listenToData();
                }
            });
        };

        const initMap = () => {
            if (map) return;
            map = L.map('map').setView([33.2148, -97.1331], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        };

        const listenToData = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'), orderBy('dateTime', 'desc'));
            document.getElementById('count').innerText = 'Loading…';

            onSnapshot(q, snap => {
                map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
                let count = 0;

                snap.forEach(doc => {
                    count++;
                    const d = doc.data();
                    if (d.gps?.includes(',')) {
                        const [lat, lng] = d.gps.split(',').map(Number);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const isWater = d.systemType === 'Water Meter';
                            const icon = L.divIcon({
                                html: `<div style="background:${isWater?'#2563eb':'#dc2626'};width:22px;height:22px;border-radius:${isWater?'50%':'4px'};
                                        border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.5);color:white;font-weight:bold;
                                        display:flex;align-items:center;justify-content:center;font-size:11px;">${isWater?'W':'S'}</div>`,
                                iconSize: [22,22]
                            });
                            L.marker([lat, lng], {icon}).addTo(map).bindPopup(
                                `<b class="${isWater?'text-blue-600':'text-red-600'} font-black">${isWater?'Water Meter':'Sprinkler'}</b><br>${d.address||''}<br>${(d.dateTime||'').replace('T',' ')}`
                            );
                        }
                    }
                });

                document.getElementById('count').innerText = count + ' Reports';
            });
        };

        // FIXED: Always gets fresh, complete data directly from Firestore
        window.exportToCSV = async function() {
            try {
                const btn = document.querySelector('button[onclick="exportToCSV()"]');
                if (btn) btn.disabled = true;

                const snapshot = await getDocs(
                    query(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'), 
                          orderBy('dateTime', 'desc'))
                );

                if (snapshot.empty) {
                    alert("No reports in database.");
                    return;
                }

                const headers = ["Type","Address","Date/Time","Latitude","Longitude","Street Location","Within 20ft","Beyond 20ft","Damage","Notes"];
                const rows = [];

                snapshot.forEach(doc => {
                    const d = doc.data();
                    let lat = "N/A", lng = "N/A";
                    if (d.gps && d.gps.includes(',')) {
                        [lat, lng] = d.gps.split(',').map(s => s.trim());
                    }

                    rows.push([
                        d.systemType || "",
                        d.address || "",
                        (d.dateTime || "").replace('T', ' '),
                        lat, lng,
                        d.locStreet || "",
                        d.loc20 || "",
                        d.locBeyond || "",
                        d.damage || "",
                        d.notes || ""
                    ].map(v => `"${(v+"").replace(/"/g, '""')}"`).join(","));
                });

                const csv = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
                const a = document.createElement('a');
                a.href = encodeURI(csv);
                a.download = `Water_Shutoffs_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();

                alert(`Success! Exported all ${rows.length} reports.`);
            } catch (e) {
                alert("Export failed: " + e.message);
            } finally {
                const btn = document.querySelector('button[onclick="exportToCSV()"]');
                if (btn) btn.disabled = false;
            }
        };

        // CLEAR ALL DATA (safe + visible)
        window.nukeDatabasePrompt = async function() {
            const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'));
            const n = snapshot.size;
            if (n === 0) return alert("No reports to delete.");

            const pw = prompt(`Delete ALL ${n} reports permanently?\n\nCSV backup will download first.\n\nEnter password:`);
            if (pw !== "FDADMIN") return alert("Wrong password.");

            if (!confirm(`IRREVERSIBLE: Delete all ${n} reports?`)) return;

            exportToCSV();
            setTimeout(async () => {
                try {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
                    document.getElementById('count').innerText = '0 Reports';
                    alert("All reports deleted.");
                } catch (e) { alert("Delete failed: " + e.message); }
            }, 1500);
        };
    </script>

    <style>
        .hero-bg { background:#152a40 url('https://www.transparenttextures.com/patterns/cubes.png'); }
        #login-overlay { position:fixed; inset:0; background:#152a40; z-index:9999; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <div id="login-overlay">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-sm">
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-24 mx-auto mb-6">
            <h2 class="text-3xl font-black text-navy uppercase">Admin Access</h2>
            <input type="password" id="admin-pass" class="w-full border-2 rounded-lg px-4 py-3 mt-8 text-center text-xl tracking-widest">
            <p id="login-error" class="text-red-600 font-bold mt-2 hidden">Wrong</p>
            <button onclick="checkLogin()" class="w-full bg-navy text-white font-bold py-4 rounded-lg mt-4 hover:bg-gray-800">LOGIN</button>
        </div>
    </div>

    <div id="dashboard-view" class="hidden flex flex-col h-full">
        <div class="hero-bg text-white py-6 text-center shadow-lg">
            <div class="flex justify-center items-center gap-4">
                <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-14">
                <div><h1 class="text-2xl font-black uppercase">Water Shutoff</h1><p class="text-yellow font-bold">COMMAND DASHBOARD</p></div>
            </div>
        </div>

        <div class="bg-white shadow-md px-4 py-3 border-b">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                <a href="water_shutoff.html" class="bg-navy text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">+ New Submission</a>
                <div class="flex gap-5 text-xs font-bold text-gray-600 bg-gray-50 px-5 py-2 rounded-full">
                    <span class="flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-blue-600 text-white text-[10px] flex items-center justify-center font-black">W</div> Water</span>
                    <span class="flex items-center gap-2"><div class="w-5 h-5 rounded bg-red-600 text-white text-[10px] flex items-center justify-center font-black">S</div> Sprinkler</span>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <span id="count" class="bg-gray-200 px-4 py-2 rounded-full font-bold">…</span>
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded-lg">CSV</button>
                    <button onclick="nukeDatabasePrompt()" class="bg-red-600 hover:bg-red-800 text-white font-bold px-6 py-2 rounded-lg">CLEAR ALL DATA</button>
                    <button onclick="performLogout()" class="text-gray-500 hover:text-red-600 font-bold">LOGOUT</button>
                </div>
            </div>
        </div>

        <div id="map" class="flex-1 bg-gray-200"></div>
    </div>
</body>
</html>
