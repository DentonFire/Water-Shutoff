<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Water Shutoff</title>
   
    <link rel="icon" type="image/png" href="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png">
   
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { navy: '#152a40', red: '#bf2726', yellow: '#f9c031' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1iKuBTPQLULOnEHISUEoU62nAi_h2nPA",
            authDomain: "denton-fire-tools.firebaseapp.com",
            projectId: "denton-fire-tools",
            storageBucket: "denton-fire-tools.firebasestorage.app",
            messagingSenderId: "751121603550",
            appId: "1:751121603550:web:3a8f25b990d45038ae1b4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'denton-fire-tools';

        let map;
        let allReports = [];

        // ==================== AUTH & SESSION ====================
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('denton_admin_session') === 'active') {
                showDashboard();
                connectFirebase();
            }
        });

        window.checkLogin = function() {
            const pass = document.getElementById('admin-pass').value;
            const errorMsg = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            if (pass === "FDADMIN") {
                loginBtn.innerHTML = "Connecting...";
                localStorage.setItem('denton_admin_session', 'active');
                showDashboard();
                connectFirebase();
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('admin-pass').value = '';
            }
        };

        window.performLogout = function() {
            localStorage.removeItem('denton_admin_session');
            signOut(auth).then(() => location.reload());
        };

        window.handleEnter = function(e) {
            if (e.key === 'Enter') window.checkLogin();
        };

        function showDashboard() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('dashboard-view').classList.remove('hidden');
            setTimeout(() => { if (map) map.invalidateSize(); }, 300);
        }

        function connectFirebase() {
            signInAnonymously(auth).catch(err => {
                console.error("Auth error:", err);
                alert("Connection failed: " + err.message);
            });

            onAuthStateChanged(auth, user => {
                if (user) {
                    initMap();
                    listenToData();
                }
            });
        }

        // ==================== MAP SETUP ====================
        function initMap() {
            if (map) {
                map.invalidateSize();
                return;
            }
            map = L.map('map').setView([33.2148, -97.1331], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // ==================== DATA LISTENER (FIXED PATH!) ====================
        function listenToData() {
            // This is the EXACT path you showed in Firebase Console
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'),
                orderBy('dateTime', 'desc')
            );

            // Loading state
            document.getElementById('count').innerText = 'Loading reports...';

            onSnapshot(q, (snapshot) => {
                // Clear old markers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) map.removeLayer(layer);
                });

                allReports = [];

                snapshot.forEach(doc => {
                    const d = doc.data();
                    allReports.push(d);

                    if (d.gps && d.gps.includes(',')) {
                        const [lat, lng] = d.gps.split(',').map(Number);
                        if (isNaN(lat) || isNaN(lng)) return;

                        const isWater = d.systemType === 'Water Meter';
                        const color = isWater ? '#2563eb' : '#dc2626';
                        const radius = isWater ? '50%' : '2px';
                        const label = isWater ? 'W' : 'S';

                        const iconHtml = `
                            <div style="background:${color};width:20px;height:20px;border-radius:${radius};
                                border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.4);
                                display:flex;align-items:center;justify-content:center;
                                color:white;font-weight:bold;font-size:10px;">${label}</div>`;

                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: iconHtml,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);

                        const popupContent = `
                            <div class="text-sm">
                                <strong class="uppercase font-black text-${isWater ? 'blue-600' : 'red-600'}">
                                    ${isWater ? 'Water Meter' : 'Sprinkler System'}
                                </strong><br>
                                <b>${d.address || 'No address'}</b><br>
                                <small class="text-gray-600">${d.dateTime ? d.dateTime.replace('T', ' ') : 'No timestamp'}</small>
                                ${d.damage === 'Yes' ? '<br><span class="inline-block mt-1 bg-red-600 text-white text-xs px-2 py-1 rounded font-bold">DAMAGED</span>' : ''}
                                ${d.notes ? `<p class="mt-2 pt-2 border-t text-xs italic text-gray-700">"${d.notes}"</p>` : ''}
                            </div>`;
                        marker.bindPopup(popupContent);
                    }
                });

                document.getElementById('count').innerText = `${allReports.length} Reports`;
            }, (error) => {
                console.error("Firestore error:", error);
                document.getElementById('count').innerText = 'Error loading';
                alert("Failed to load data: " + error.message);
            });
        }

        // ==================== CSV EXPORT (NOW 100% ACCURATE) ====================
        window.exportToCSV = function() {
            if (allReports.length === 0) {
                alert("No reports to export yet.");
                return;
            }

            const headers = [
                "Type",
                "Address",
                "Date/Time",
                "Latitude",
                "Longitude",
                "Street Location",
                "Within 20ft of Hydrant",
                "Beyond Hydrant",
                "Damage",
                "Notes"
            ];

            const rows = allReports.map(r => {
                let lat = "N/A", lng = "N/A";
                if (r.gps && r.gps.includes(',')) {
                    [lat, lng] = r.gps.split(',').map(s => s.trim());
                }
                return [
                    r.systemType || "",
                    r.address || "",
                    r.dateTime || "",
                    lat,
                    lng,
                    r.locStreet || "",
                    r.loc20 || "",
                    r.locBeyond || "",
                    r.damage || "",
                    r.notes || ""
                ].map(val => `"${(val + "").replace(/"/g, '""')}"`).join(",");
            });

            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `Water_Shutoff_Reports_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>

    <style>
        .hero-bg { background-color: #152a40; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
        .leaflet-pane { z-index: 0 !important; }
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #152a40; z-index: 9999; display: flex; 
            align-items: center; justify-content: center; 
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full text-center mx-4">
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" alt="Denton Fire" class="h-20 mx-auto mb-6">
            <h2 class="text-2xl font-black text-navy mb-1 uppercase">Admin Access</h2>
            <p class="text-gray-500 text-sm mb-6">Denton Fire Dept. Internal Dashboard</p>
            <input type="password" id="admin-pass" onkeyup="handleEnter(event)" placeholder="Enter Password" 
                   class="w-full border-2 border-gray-300 rounded p-3 text-lg mb-4 focus:border-navy focus:outline-none text-center tracking-widest">
            <p id="login-error" class="text-red-600 font-bold text-sm mb-4 hidden">Incorrect Password</p>
            <button id="login-btn" onclick="checkLogin()" 
                    class="w-full bg-navy text-white font-bold py-3 rounded hover:bg-gray-800 transition">Login</button>
            <p class="mt-6 text-xs text-gray-400">Authorized Personnel Only</p>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-view" class="hidden flex flex-col h-full">
        <!-- Hero -->
        <div class="hero-bg text-white py-6 px-4 text-center shrink-0 shadow-lg relative z-20">
            <div class="flex items-center justify-center gap-4">
                <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" alt="Patch" class="h-12 drop-shadow-lg">
                <div class="text-left">
                    <h1 class="text-xl font-black uppercase tracking-wide leading-none">Water Shutoff</h1>
                    <p class="text-yellow text-xs font-bold tracking-widest">COMMAND DASHBOARD</p>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-white border-b border-gray-200 p-3 shadow-md z-10 shrink-0">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3">
                <a href="water_shutoff.html" class="bg-navy text-white text-sm font-bold py-2 px-4 rounded hover:bg-gray-800 transition shadow-sm flex items-center gap-2">
                    <span>+</span> New Submission
                </a>

                <div class="flex gap-6 text-xs font-bold text-gray-600 bg-gray-50 px-4 py-2 rounded-full border border-gray-200">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-600 border border-white shadow flex items-center justify-center text-white text-[9px]">W</div>
                        Water Meter
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-sm bg-red-600 border border-white shadow flex items-center justify-center text-white text-[9px]">S</div>
                        Sprinkler
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <span id="count" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">Connecting...</span>
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded transition flex items-center gap-1">
                        CSV
                    </button>
                    <button onclick="performLogout()" class="text-gray-400 hover:text-red-500 text-xs font-bold px-2 py-2 rounded transition" title="Logout">
                        LOGOUT
                    </button>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map" class="flex-grow w-full z-0 bg-gray-200"></div>
    </div>
</body>
</html>
