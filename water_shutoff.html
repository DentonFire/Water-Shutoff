<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Shutoff Survey</title>
    <link rel="icon" type="image/png" href="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { navy: '#152a40', red: '#bf2726', yellow: '#f9c031' },
                    animation: { 
                        'bounce-short': 'bounce 1s infinite',
                        'scan': 'scan-line 3s linear infinite'
                    },
                    keyframes: {
                        'scan-line': {
                            '0%': { backgroundPosition: '100% 0' },
                            '100%': { backgroundPosition: '-100% 0' },
                        }
                    }
                } 
            }
        }
    </script>

    <style>
        body { background-color: #f3f4f6; padding: 20px; }
        .paper-doc { background: white; max-width: 40rem; margin: 0 auto; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0.5rem; position: relative; }
        input[type="radio"]:checked + div { background-color: #152a40; color: white; border-color: #152a40; }
        #address-results::-webkit-scrollbar { width: 6px; }
        #address-results::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .modal-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* QR Modal Animation */
        .fade-in { animation: fadeIn 0.2s ease-out; }

        /* Login/Redirect Screen Styles (Matches Index.html) */
        #auth-loading { 
            background-color: #152a40; 
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'), radial-gradient(circle at top right, #1e3a58, #152a40);
            background-repeat: repeat, no-repeat;
        }
        .scan-line-gradient { background: linear-gradient(90deg, #152a40 0%, #ef4444 50%, #152a40 100%); background-size: 200% 100%; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1iKuBTPQLULOnEHISUEoU62nAi_h2nPA",
            authDomain: "denton-fire-tools.firebaseapp.com",
            projectId: "denton-fire-tools",
            storageBucket: "denton-fire-tools.firebasestorage.app",
            messagingSenderId: "751121603550",
            appId: "1:751121603550:web:3a8f25b990d45038ae1b4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'denton-fire-tools';

        let currentUser = null;

        // --- SAFE REDIRECT HELPER ---
        function safeRedirect(target) {
            try {
                window.location.assign(target);
            } catch (e) {
                console.warn("Redirect blocked by environment:", e);
                // Fallback UI matching the login page aesthetics
                const loader = document.getElementById('auth-loading');
                if (loader) {
                    loader.innerHTML = `
                        <div class="bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 scan-line-gradient animate-scan"></div>
                            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" alt="Denton Fire" class="h-16 w-auto mx-auto mb-4 drop-shadow-lg object-contain">
                            <h2 class="text-2xl font-black text-white mb-1 uppercase tracking-tight">Login Required</h2>
                            <p class="text-blue-200 text-xs mb-6 font-medium tracking-wide uppercase">Water Shutoff Survey</p>
                            
                            <div class="space-y-3">
                                <p class="text-white text-sm">Please log in to access this form.</p>
                                <a href="${target}" class="block w-full bg-white text-navy font-black py-3 rounded-lg hover:bg-gray-100 transition shadow-lg uppercase tracking-wider text-xs">
                                    Proceed to Login
                                </a>
                            </div>
                            
                            <div id="security-badge" class="mt-6 flex items-center justify-center gap-2 opacity-60">
                                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                                <p class="text-[10px] font-mono tracking-widest uppercase text-white">ACCESS RESTRICTED</p>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // --- AUTH PROTECTION & SECURITY CURTAIN ---
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('auth-loading');
            
            // 1. Not Logged In?
            if (!user) {
                safeRedirect("index.html?redirect=water_shutoff");
                return;
            } 
            
            // 2. Email Wrong Domain?
            if (!user.email.endsWith('@cityofdenton.com')) {
                alert("Unauthorized Access");
                safeRedirect("index.html");
                return;
            }

            // 3. Email Not Verified?
            if (!user.emailVerified) {
                alert("Please verify your email address first.\nCheck your inbox for the verification link.");
                signOut(auth);
                safeRedirect("index.html");
                return;
            }

            // 4. Session Expired (30 days)?
            const loginTime = localStorage.getItem('denton_login_time');
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;
            if (loginTime && (Date.now() - parseInt(loginTime) > thirtyDays)) {
                alert("Session Expired. Please log in again.");
                localStorage.removeItem('denton_login_time');
                signOut(auth);
                safeRedirect("index.html?redirect=water_shutoff");
                return;
            }

            // --- ACCESS GRANTED ---
            currentUser = user;
            // Lift the curtain
            if(loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
            }
        });

        // --- UNIT MANAGEMENT ---
        const defaultUnits = ["BAT1", "BAT2", "RIV9", "E1", "T1", "E2", "E3", "E4", "E6", "Q5", "E7", "E8", "M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "R1", "BLK3"];

        window.loadUnits = function() {
            const select = document.getElementById('unit-select');
            select.innerHTML = `<option value="">Select Unit...</option>`;
            
            defaultUnits.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.innerText = u; select.appendChild(opt);
            });

            const savedUnits = JSON.parse(localStorage.getItem('denton_custom_units') || '[]');
            if (savedUnits.length > 0) {
                const divider = document.createElement('option');
                divider.disabled = true; divider.innerText = "--- Saved Units ---"; select.appendChild(divider);
                savedUnits.forEach(u => {
                    if (!defaultUnits.includes(u)) {
                        const opt = document.createElement('option');
                        opt.value = u; opt.innerText = u; select.appendChild(opt);
                    }
                });
            }
            const addNew = document.createElement('option');
            addNew.value = "ADD_NEW"; addNew.innerText = "‚ûï Add New Unit..."; addNew.className = "font-bold text-navy";
            select.appendChild(addNew);
        }

        window.handleUnitChange = function() {
            const select = document.getElementById('unit-select');
            const customInputDiv = document.getElementById('custom-unit-div');
            if (select.value === 'ADD_NEW') {
                customInputDiv.classList.remove('hidden');
                document.getElementById('custom-unit-input').focus();
            } else {
                customInputDiv.classList.add('hidden');
            }
        }

        window.saveNewUnit = function(newUnitName) {
            if (!newUnitName) return;
            const savedUnits = JSON.parse(localStorage.getItem('denton_custom_units') || '[]');
            if (!savedUnits.includes(newUnitName) && !defaultUnits.includes(newUnitName)) {
                savedUnits.push(newUnitName);
                localStorage.setItem('denton_custom_units', JSON.stringify(savedUnits));
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('datetime').value = now.toISOString().slice(0, 16);
            loadUnits();
        });

        // --- SUBMIT LOGIC ---
        window.initiateSubmit = function() {
            // Validation
            const address = document.getElementById('address').value;
            const dateTime = document.getElementById('datetime').value;
            const systemTypeElement = document.querySelector('input[name="systemType"]:checked');
            const unitSelect = document.getElementById('unit-select');
            let unitVal = unitSelect.value;
            
            if (unitVal === 'ADD_NEW') {
                const customInput = document.getElementById('custom-unit-input').value;
                if (customInput && customInput.trim() !== "") unitVal = customInput.trim().toUpperCase();
                else unitVal = null;
            }

            const damageElement = document.querySelector('input[name="damage"]:checked');
            const damage = damageElement ? damageElement.value : "No"; 
            const notes = document.getElementById('notes').value;

            const missingFields = [];
            if (!unitVal) missingFields.push("Unit Number");
            if (!address || !address.trim()) missingFields.push("Shutoff Address");
            if (!systemTypeElement) missingFields.push("System Type");
            if (!dateTime) missingFields.push("Date/Time");
            if (damage === "Yes" && (!notes || !notes.trim())) missingFields.push("Description of Damage");

            if (missingFields.length > 0) {
                alert("Please fill in the following required fields:\n\n- " + missingFields.join("\n- "));
                return;
            }

            // Fire Watch Check
            if (document.getElementById('fire-watch-check').checked) {
                finalSubmit(); // Skip modal if already issued
            } else {
                document.getElementById('firewatch-modal').classList.remove('hidden'); // Show reminder
            }
        }

        window.finalSubmit = async function() {
            document.getElementById('firewatch-modal').classList.add('hidden');
            
            const btn = document.getElementById('submit-btn');
            const originalText = "üì§ Submit & Generate Email"; 
            btn.innerText = "‚è≥ Processing...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                // Gather Data
                const address = document.getElementById('address').value;
                const dateTime = document.getElementById('datetime').value;
                const systemType = document.querySelector('input[name="systemType"]:checked').value;
                const gps = document.getElementById('gps-coords').value;
                const damage = document.querySelector('input[name="damage"]:checked').value;
                const notes = document.getElementById('notes').value;
                
                const locStreet = document.getElementById('loc-street').value;
                const loc20 = document.getElementById('loc-20ft').value;
                const locBeyond = document.getElementById('loc-beyond').value;

                let unitVal = document.getElementById('unit-select').value;
                if (unitVal === 'ADD_NEW') {
                    unitVal = document.getElementById('custom-unit-input').value.trim().toUpperCase();
                    saveNewUnit(unitVal);
                }

                // Determine Fire Watch Status
                const fireWatchStatus = document.getElementById('fire-watch-check').checked ? "Yes" : "No";

                const isWaterMeter = (systemType === 'Water Meter');
                
                const reportData = {
                    unit: unitVal,
                    address: address,
                    dateTime: dateTime,
                    systemType: systemType,
                    gps: gps || "", 
                    damage: damage,
                    notes: notes || "", 
                    fireWatch: fireWatchStatus,
                    locStreet: isWaterMeter ? locStreet : "N/A",
                    loc20: isWaterMeter ? loc20 : "N/A",
                    locBeyond: isWaterMeter ? locBeyond : "N/A",
                    timestamp: serverTimestamp(),
                    userId: currentUser ? currentUser.uid : 'anonymous'
                };

                if (db && currentUser) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'), reportData);
                }
                
                alert("‚úÖ Report logged! Opening email client...");
                generateEmail(reportData);
                
                // Reset
                document.getElementById('shutoffForm').reset();
                document.getElementById('location-details').classList.add('hidden');
                document.getElementById('damage-details').classList.add('hidden');
                document.getElementById('custom-unit-div').classList.add('hidden');
                loadUnits();
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('datetime').value = now.toISOString().slice(0, 16);

            } catch (e) {
                console.error("Submit Error:", e);
                alert("Database error (" + e.message + "). Email fallback generated.");
                generateEmail(reportData); // Try generating email anyway
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        function generateEmail(data) {
            let recipient, subject, locationBlock;
            
            if (data.systemType === "Water Meter") {
                recipient = "watermetering@cityofdenton.com";
                subject = `Water Meter Shutoff - Unit ${data.unit}`;
                locationBlock = `LOCATION DETAILS\n--------------------------------\nAt Street: ${data.locStreet || 'N/A'}\nWithin 20ft: ${data.loc20 || 'N/A'}\nBeyond 20ft: ${data.locBeyond || 'N/A'}`;
            } else {
                recipient = "FirePrevention@cityofdenton.com";
                subject = `Sprinkler System Shutoff - Unit ${data.unit}`;
                locationBlock = ""; 
            }

            let mapLink = "N/A";
            if (data.gps) {
                mapLink = `https://www.google.com/maps/search/?api=1&query=${data.gps}`;
            } else if (data.address) {
                mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.address)}`;
            }

            const body = 
`SHUTOFF REPORT
--------------------------------
UNIT: ${data.unit || 'N/A'}
TYPE: ${data.systemType || 'N/A'}
ADDRESS: ${data.address || 'N/A'}
DATE/TIME: ${(data.dateTime || '').replace('T', ' ')}
FIRE WATCH ISSUED: ${data.fireWatch || 'No'}

${locationBlock}

MAP LINK: ${mapLink}

DAMAGE REPORT
--------------------------------
Damaged: ${data.damage || 'No'}
${data.damage === 'Yes' ? `Description: ${data.notes || ''}` : ''}

Logged via Denton Fire Dept Water Shutoff Survey`;

            window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // --- UI HELPERS ---
        window.toggleQrModal = function() {
            const modal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            
            // Toggle visibility
            modal.classList.toggle('hidden');

            // Generate the QR code only if we are opening it
            if (!modal.classList.contains('hidden')) {
                const targetUrl = 'https://dentonfire.github.io/Water-Shutoff/water_shutoff.html';
                qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(targetUrl)}`;
            }
        }
        
        window.closeFireWatchModal = function() { document.getElementById('firewatch-modal').classList.add('hidden'); }

        window.getGPS = function() {
            const btn = document.getElementById('gps-btn');
            btn.innerHTML = "<span>‚è≥</span> Requesting...";
            if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                document.getElementById('gps-coords').value = `${lat},${lon}`;
                document.getElementById('gps-status').classList.remove('hidden');
                document.getElementById('gps-status').innerText = `‚úì ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                
                // Reverse Geo
                fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.features && d.features.length) {
                            const p = d.features[0].properties;
                            const addr = [p.name, p.housenumber, p.street, p.city].filter(Boolean).join(', ');
                            if(addr) document.getElementById('address').value = addr;
                        }
                    });
                btn.innerHTML = "<span>üìç</span> Update Location";
            }, () => { alert("GPS Error"); btn.innerHTML = "<span>üìç</span> Get My Location"; });
        }

        window.toggleFields = function() {
            const type = document.querySelector('input[name="systemType"]:checked').value;
            const detailsDiv = document.getElementById('location-details');
            const info = document.getElementById('routing-info');
            if (type === 'Water Meter') {
                detailsDiv.classList.remove('hidden');
                info.innerHTML = `Logs to database + Routes to: <strong>Water Distribution Dept.</strong>`;
            } else {
                detailsDiv.classList.add('hidden');
                info.innerHTML = `Logs to database + Routes to: <strong>Fire Prevention Division</strong>`;
            }
        }

        window.toggleDamage = function() {
            const val = document.querySelector('input[name="damage"]:checked').value;
            const div = document.getElementById('damage-details');
            if (val === 'Yes') div.classList.remove('hidden'); else { div.classList.add('hidden'); document.getElementById('notes').value = ''; }
        }

        // Address Autocomplete
        let debounceTimer;
        window.handleAddressInput = function(e) {
            const query = e.target.value;
            const resDiv = document.getElementById('address-results');
            resDiv.innerHTML = ''; resDiv.classList.add('hidden');
            clearTimeout(debounceTimer);
            if (query.length < 3) return;

            debounceTimer = setTimeout(async () => {
                try {
                    const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lat=33.2148&lon=-97.1331&limit=5`);
                    if(!r.ok) return;
                    const d = await r.json();
                    if(d.features && d.features.length) {
                        resDiv.classList.remove('hidden');
                        d.features.forEach(f => {
                            const p = f.properties;
                            const name = [p.name, p.housenumber, p.street, p.city].filter(Boolean).join(', ');
                            const div = document.createElement('div');
                            div.className = "p-3 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100";
                            div.innerText = name;
                            div.onclick = () => {
                                document.getElementById('address').value = name;
                                resDiv.classList.add('hidden');
                                if(f.geometry?.coordinates) {
                                    const [lon, lat] = f.geometry.coordinates;
                                    document.getElementById('gps-coords').value = `${lat},${lon}`;
                                    document.getElementById('gps-status').classList.remove('hidden');
                                    document.getElementById('gps-status').innerText = "‚úì Location Auto-filled";
                                }
                            };
                            resDiv.appendChild(div);
                        });
                    }
                } catch(e) {}
            }, 300);
        }
    </script>
</head>
<body class="relative">

    <!-- SECURITY CURTAIN: Prevents seeing the form before auth check completes -->
    <div id="auth-loading" class="fixed inset-0 z-[10000] flex items-center justify-center transition-opacity duration-500 px-4">
        <div class="bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 scan-line-gradient animate-scan"></div>
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" alt="Denton Fire" class="h-16 w-auto mx-auto mb-4 drop-shadow-lg object-contain">
            <h2 class="text-2xl font-black text-white mb-1 uppercase tracking-tight">Verifying Access</h2>
            <p class="text-blue-200 text-xs mb-6 font-medium tracking-wide uppercase">Water Shutoff Survey</p>
            
            <div class="space-y-3">
                <div class="text-white/70 text-sm animate-pulse">Connecting to secure server...</div>
            </div>
            
            <div id="security-badge" class="mt-6 flex items-center justify-center gap-2 opacity-60">
                <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                <p class="text-[10px] font-mono tracking-widest uppercase text-white">CHECKING CREDENTIALS</p>
            </div>
        </div>
    </div>

    <div class="paper-doc">
        <!-- REMOVED HEADER UTILITY BAR -->

        <div class="text-center border-b-4 border-yellow pb-6 mb-6 mt-4">
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-20 mx-auto mb-3">
            <h1 class="text-2xl font-black text-navy uppercase tracking-wide">Water Shutoff Survey</h1>
            <p class="text-gray-600 text-sm mt-2">Log Sprinkler or Water Meter shutoffs for Fire Prevention & Water Dept.</p>
        </div>

        <form id="shutoffForm" class="space-y-8">
            <!-- 1. Unit Selection -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">1. Unit Identification</h2>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Unit <span class="text-red">*</span></label>
                    <select id="unit-select" onchange="handleUnitChange()" class="w-full border border-gray-300 rounded p-2 focus:border-navy outline-none bg-white font-bold text-navy"></select>
                    <div id="custom-unit-div" class="hidden mt-3 animate-fade-in">
                        <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Enter New Unit Name:</label>
                        <input type="text" id="custom-unit-input" class="w-full border-2 border-blue-300 rounded p-2 focus:border-blue-600 outline-none uppercase placeholder-gray-400" placeholder="Ex: E9, SQ1, etc.">
                    </div>
                </div>
            </div>

            <!-- 2. Location -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">2. Location & Time</h2>
                <div class="space-y-4">
                    <div id="address-container" class="relative">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Shutoff Address <span class="text-red">*</span></label>
                        <input type="text" id="address" oninput="handleAddressInput(event)" class="w-full border border-gray-300 rounded p-2 focus:border-navy outline-none" placeholder="123 Example St, Denton, TX" autocomplete="off">
                        <div id="address-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b shadow-lg hidden mt-0 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date/Time <span class="text-red">*</span></label>
                            <input type="datetime-local" id="datetime" class="w-full border border-gray-300 rounded p-2 focus:border-navy outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">GPS Coords (Optional)</label>
                            <button type="button" id="gps-btn" onclick="getGPS()" class="w-full bg-white border border-navy text-navy font-bold py-2 rounded hover:bg-navy hover:text-white transition text-xs flex items-center justify-center gap-2"><span>üìç</span> Get My Location</button>
                            <input type="hidden" id="gps-coords">
                            <div id="gps-status" class="text-xs text-green-600 mt-1 hidden">‚úì Location Acquired</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. System -->
            <div>
                <h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">3. System Information</h2>
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer"><input type="radio" name="systemType" value="Water Meter" class="hidden" onchange="toggleFields()"><div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-navy transition font-bold text-gray-600">üíß Water Meter</div></label>
                    <label class="cursor-pointer"><input type="radio" name="systemType" value="Sprinkler System" class="hidden" onchange="toggleFields()"><div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-navy transition font-bold text-gray-600">üßØ Sprinkler System</div></label>
                </div>
            </div>

            <div id="location-details" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 class="text-navy font-bold text-md mb-3">Location Relative to Address</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">At the street:</span><select id="loc-street" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha (Front)</option><option value="Bravo">Bravo (Left)</option><option value="Charlie">Charlie (Rear)</option><option value="Delta">Delta (Right)</option></select></div>
                    <div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">Within 20ft:</span><select id="loc-20ft" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha</option><option value="Bravo">Bravo</option><option value="Charlie">Charlie</option><option value="Delta">Delta</option></select></div>
                    <div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">Beyond 20ft:</span><select id="loc-beyond" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha</option><option value="Bravo">Bravo</option><option value="Charlie">Charlie</option><option value="Delta">Delta</option></select></div>
                </div>
            </div>

            <!-- 4. Damage -->
            <div>
                <h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">4. Damage Report</h2>
                <div class="mb-4">
                    <span class="block text-sm font-bold text-gray-700 mb-2">Was the system damaged?</span>
                    <div class="flex gap-6">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="damage" value="Yes" class="w-4 h-4 text-navy" onchange="toggleDamage()"><span class="text-sm">Yes</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="damage" value="No" class="w-4 h-4 text-navy" checked onchange="toggleDamage()"><span class="text-sm">No</span></label>
                    </div>
                </div>
                <div id="damage-details" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description of Damage <span class="text-red">*</span></label>
                    <textarea id="notes" rows="3" class="w-full border border-gray-300 rounded p-2 focus:border-navy outline-none" placeholder="Please describe the damage..."></textarea>
                </div>
            </div>

            <!-- Actions -->
            <div class="pt-6">
                <!-- Fire Watch Section (MOVED HERE) -->
                <div class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <!-- Checkbox -->
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-50 px-4 py-3 rounded-lg border border-gray-200 shadow-sm hover:bg-gray-100 transition select-none w-full sm:w-auto justify-center">
                        <input type="checkbox" id="fire-watch-check" class="w-5 h-5 text-navy rounded focus:ring-navy cursor-pointer">
                        <span class="text-sm font-bold text-navy">Fire Watch Issued</span>
                    </label>

                    <!-- Link Button -->
                    <a href="https://dentonfire.github.io/Fire-Watch/" target="_blank" class="bg-red text-white px-4 py-3 rounded-lg shadow hover:bg-red-700 hover:scale-105 text-xs font-bold uppercase flex items-center justify-center gap-2 w-full sm:w-auto transition transform duration-200" title="Fire Watch Protocols">
                        <span class="text-lg">üî•</span> Fire Watch
                    </a>
                </div>

                <button type="button" id="submit-btn" onclick="initiateSubmit()" class="w-full bg-navy text-white font-bold py-4 rounded-lg hover:bg-gray-800 transition shadow-lg flex items-center justify-center gap-2 text-lg">üì§ Submit & Generate Email</button>
                <p id="routing-info" class="text-center text-xs text-gray-500 mt-2">Submitting logs the data to the map and opens your email client.</p>
            </div>
        </form>
    </div>

    <!-- ============================================ -->
    <!-- NEW FLOATING QR CODE BUTTON & MODAL START -->
    <!-- ============================================ -->

    <!-- The Floating Button -->
    <div class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleQrModal()" 
                class="bg-navy/90 hover:bg-navy text-white rounded-full w-14 h-14 md:w-16 md:h-16 flex items-center justify-center shadow-2xl border-2 border-white/20 transition-all hover:scale-110 backdrop-blur-sm group">
            <!-- QR Icon SVG -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 md:w-8 md:h-8 group-hover:stroke-yellow transition-colors">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
            </svg>
        </button>
    </div>

    <!-- The Modal (Hidden by Default) -->
    <div id="qr-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-navy/80 backdrop-blur-sm transition-opacity" onclick="toggleQrModal()"></div>

        <!-- Modal Panel -->
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm fade-in">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 text-center">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-navy/10 sm:mx-auto mb-4">
                            <svg class="h-6 w-6 text-navy" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                            </svg>
                        </div>
                        <h3 class="text-base font-semibold leading-6 text-gray-900 mb-2">Scan for Mobile Access</h3>
                        <p class="text-sm text-gray-500 mb-4">Scan this code to open this resource on your mobile device.</p>
                        
                        <!-- Generated QR Code Image -->
                        <div class="flex justify-center p-2 border border-gray-100 rounded bg-gray-50">
                            <img id="qr-image" src="" alt="QR Code" class="w-48 h-48 mix-blend-multiply">
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" onclick="toggleQrModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: FIRE WATCH REMINDER -->
    <div id="firewatch-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-navy/90 hidden backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 text-center border-t-8 border-red modal-fade-in">
            <div class="w-12 h-12 bg-red-100 text-red rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-2xl">üî•</span></div>
            <h3 class="text-navy font-black text-xl mb-1">FIRE WATCH REMINDER</h3>
            <p class="text-gray-600 text-sm mb-6">If the suppression system is down, have you issued a <strong>Fire Watch</strong>?</p>
            <div class="space-y-3">
                <a href="https://dentonfire.github.io/Fire-Watch/" target="_blank" class="block w-full bg-red text-white font-bold py-3 rounded hover:bg-red-700 transition flex items-center justify-center gap-2"><span>üìÑ</span> Open Guidelines</a>
                <!-- Updated Button Text -->
                <button onclick="finalSubmit()" class="block w-full bg-gray-100 text-navy font-bold py-3 rounded hover:bg-gray-200 transition">Proceed to Submit ‚Üí</button>
            </div>
            <button onclick="closeFireWatchModal()" class="mt-4 text-xs text-gray-400 hover:text-gray-600">Cancel</button>
        </div>
    </div>

</body>
</html>
