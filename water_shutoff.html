<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Shutoff Survey</title>
    <link rel="icon" type="image/png" href="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { navy: '#152a40', red: '#bf2726', yellow: '#f9c031' }, animation: { 'scan': 'scan-line 3s linear infinite' }, keyframes: { 'scan-line': { '0%': { backgroundPosition: '100% 0' }, '100%': { backgroundPosition: '-100% 0' } } } } } }</script>
    <style>
        body { background-color: #f3f4f6; padding: 20px; }
        .paper-doc { background: white; max-width: 40rem; margin: 0 auto; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0.5rem; }
        input[type="radio"]:checked + div { background-color: #152a40; color: white; border-color: #152a40; }
        #address-results::-webkit-scrollbar { width: 6px; }
        #address-results::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .modal-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #auth-loading { background-color: #152a40; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'), radial-gradient(circle at top right, #1e3a58, #152a40); }
        .scan-line-gradient { background: linear-gradient(90deg, #152a40 0%, #ef4444 50%, #152a40 100%); background-size: 200% 100%; }
        #offline-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #f59e0b, #d97706); color: white; padding: 10px 16px; text-align: center; font-weight: 700; font-size: 12px; z-index: 10000; text-transform: uppercase; }
        #offline-banner.show { display: block; }
        body.offline-mode { padding-top: 56px; }
        #clipboard-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #152a40; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; z-index: 10001; opacity: 0; transition: all 0.3s ease; }
        #clipboard-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #main-content.visible { opacity: 1; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC1iKuBTPQLULOnEHISUEoU62nAi_h2nPA", authDomain: "denton-fire-tools.firebaseapp.com", projectId: "denton-fire-tools", storageBucket: "denton-fire-tools.firebasestorage.app", messagingSenderId: "751121603550", appId: "1:751121603550:web:3a8f25b990d45038ae1b4f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'denton-fire-tools';
        let currentUser = null, isOnline = navigator.onLine, pendingSubmissions = [];

        function updateOnlineStatus() { isOnline = navigator.onLine; const banner = document.getElementById('offline-banner'); if (!isOnline) { banner.classList.add('show'); document.body.classList.add('offline-mode'); } else { banner.classList.remove('show'); document.body.classList.remove('offline-mode'); processPendingSubmissions(); } }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        async function processPendingSubmissions() { if (pendingSubmissions.length === 0) return; for (const s of pendingSubmissions) { try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'), s); } catch (e) { console.error("Sync failed:", e); } } pendingSubmissions = []; localStorage.removeItem('denton_pending_submissions'); }
        function loadPendingSubmissions() { const saved = localStorage.getItem('denton_pending_submissions'); if (saved) { try { pendingSubmissions = JSON.parse(saved); } catch (e) { pendingSubmissions = []; } } }

        function safeRedirect(target) { try { window.location.assign(target); } catch (e) { console.warn("Redirect blocked:", e); const loader = document.getElementById('auth-loading'); if (loader) loader.innerHTML = '<div class="bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><div class="absolute top-0 left-0 w-full h-2 scan-line-gradient animate-scan"></div><img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-16 mx-auto mb-4"><h2 class="text-2xl font-black text-white mb-1 uppercase">Login Required</h2><p class="text-blue-200 text-xs mb-6 uppercase">Water Shutoff Survey</p><a href="'+target+'" class="block w-full bg-white text-navy font-black py-3 rounded-lg uppercase text-xs">Proceed to Login</a></div>'; } }

        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('auth-loading');
            const mainContent = document.getElementById('main-content');
            if (!user) { safeRedirect("index.html?redirect=water_shutoff"); return; }
            if (!user.email.endsWith('@cityofdenton.com')) { alert("Unauthorized"); safeRedirect("index.html"); return; }
            if (!user.emailVerified) { alert("Please verify your email first."); signOut(auth); safeRedirect("index.html"); return; }
            const loginTime = localStorage.getItem('denton_login_time');
            if (loginTime && (Date.now() - parseInt(loginTime) > 30*24*60*60*1000)) { alert("Session Expired."); localStorage.removeItem('denton_login_time'); signOut(auth); safeRedirect("index.html?redirect=water_shutoff"); return; }
            currentUser = user;
            if(loadingScreen) { loadingScreen.style.opacity = '0'; setTimeout(() => { loadingScreen.style.display = 'none'; if(mainContent) mainContent.classList.add('visible'); }, 500); }
            updateOnlineStatus(); loadPendingSubmissions();
        });

        const defaultUnits = ["BAT1", "BAT2", "RIV9", "E1", "T1", "E2", "E3", "E4", "E6", "Q5", "E7", "E8", "M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "R1", "BLK3"];
        window.loadUnits = function() { const select = document.getElementById('unit-select'); select.innerHTML = '<option value="">Select Unit...</option>'; defaultUnits.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; select.appendChild(opt); }); const savedUnits = JSON.parse(localStorage.getItem('denton_custom_units') || '[]'); if (savedUnits.length > 0) { const divider = document.createElement('option'); divider.disabled = true; divider.innerText = "--- Saved Units ---"; select.appendChild(divider); savedUnits.forEach(u => { if (!defaultUnits.includes(u)) { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; select.appendChild(opt); } }); } const addNew = document.createElement('option'); addNew.value = "ADD_NEW"; addNew.innerText = "‚ûï Add New Unit..."; select.appendChild(addNew); }
        window.handleUnitChange = function() { const select = document.getElementById('unit-select'); const customInputDiv = document.getElementById('custom-unit-div'); if (select.value === 'ADD_NEW') { customInputDiv.classList.remove('hidden'); document.getElementById('custom-unit-input').focus(); } else { customInputDiv.classList.add('hidden'); } }
        window.saveNewUnit = function(name) { if (!name) return; const savedUnits = JSON.parse(localStorage.getItem('denton_custom_units') || '[]'); if (!savedUnits.includes(name) && !defaultUnits.includes(name)) { savedUnits.push(name); localStorage.setItem('denton_custom_units', JSON.stringify(savedUnits)); } }

        window.addEventListener('DOMContentLoaded', () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('datetime').value = now.toISOString().slice(0, 16); loadUnits(); });

        window.initiateSubmit = function() {
            const address = document.getElementById('address').value;
            const dateTime = document.getElementById('datetime').value;
            const systemTypeElement = document.querySelector('input[name="systemType"]:checked');
            let unitVal = document.getElementById('unit-select').value;
            if (unitVal === 'ADD_NEW') { const ci = document.getElementById('custom-unit-input').value; if (ci && ci.trim() !== "") unitVal = ci.trim().toUpperCase(); else unitVal = null; }
            const damageElement = document.querySelector('input[name="damage"]:checked');
            const damage = damageElement ? damageElement.value : "No";
            const notes = document.getElementById('notes').value;
            const missingFields = [];
            if (!unitVal) missingFields.push("Unit Number");
            if (!address || !address.trim()) missingFields.push("Shutoff Address");
            if (!systemTypeElement) missingFields.push("System Type");
            if (!dateTime) missingFields.push("Date/Time");
            if (damage === "Yes" && (!notes || !notes.trim())) missingFields.push("Description of Damage");
            if (missingFields.length > 0) { alert("Please fill in:\n\n- " + missingFields.join("\n- ")); return; }
            if (document.getElementById('fire-watch-check').checked) finalSubmit(); else document.getElementById('firewatch-modal').classList.remove('hidden');
        }

        window.finalSubmit = async function() {
            document.getElementById('firewatch-modal').classList.add('hidden');
            const btn = document.getElementById('submit-btn');
            const originalText = "üì§ Submit & Generate Email";
            btn.innerText = "‚è≥ Processing..."; btn.disabled = true; btn.classList.add('opacity-50');

            const address = document.getElementById('address').value;
            const dateTime = document.getElementById('datetime').value;
            const systemType = document.querySelector('input[name="systemType"]:checked').value;
            const gps = document.getElementById('gps-coords').value;
            const damage = document.querySelector('input[name="damage"]:checked')?.value || 'No';
            const notes = document.getElementById('notes').value;
            const locStreet = document.getElementById('loc-street').value;
            const loc20 = document.getElementById('loc-20ft').value;
            const locBeyond = document.getElementById('loc-beyond').value;
            let unitVal = document.getElementById('unit-select').value;
            if (unitVal === 'ADD_NEW') { unitVal = document.getElementById('custom-unit-input').value.trim().toUpperCase(); saveNewUnit(unitVal); }
            const fireWatchStatus = document.getElementById('fire-watch-check').checked ? "Yes" : "No";
            const isWaterMeter = (systemType === 'Water Meter');

            const reportData = { unit: unitVal, address: address, dateTime: dateTime, systemType: systemType, gps: gps || "", damage: damage, notes: notes || "", fireWatch: fireWatchStatus, locStreet: isWaterMeter ? locStreet : "N/A", loc20: isWaterMeter ? loc20 : "N/A", locBeyond: isWaterMeter ? locBeyond : "N/A", timestamp: serverTimestamp(), userId: currentUser ? currentUser.uid : 'anonymous', submittedAt: new Date().toISOString() };

            try {
                if (!isOnline) { const offlineData = { ...reportData, timestamp: new Date().toISOString() }; pendingSubmissions.push(offlineData); localStorage.setItem('denton_pending_submissions', JSON.stringify(pendingSubmissions)); alert("üì± You're offline. Report saved locally and will sync when online."); generateEmail(reportData); }
                else if (db && currentUser) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'water_shutoffs'), reportData); alert("‚úÖ Report logged! Opening email client..."); generateEmail(reportData); }
                document.getElementById('shutoffForm').reset();
                document.getElementById('location-details').classList.add('hidden');
                document.getElementById('damage-details').classList.add('hidden');
                document.getElementById('custom-unit-div').classList.add('hidden');
                document.getElementById('gps-status').classList.add('hidden');
                loadUnits();
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('datetime').value = now.toISOString().slice(0, 16);
            } catch (e) { console.error("Submit Error:", e); alert("Database error. Email fallback generated."); generateEmail(reportData); }
            finally { btn.innerText = originalText; btn.disabled = false; btn.classList.remove('opacity-50'); }
        }

        function generateEmail(data) {
            let recipient = data.systemType === "Water Meter" ? "watermetering@cityofdenton.com" : "FirePrevention@cityofdenton.com";
            let subject = data.systemType === "Water Meter" ? `Water Meter Shutoff - Unit ${data.unit}` : `Sprinkler System Shutoff - Unit ${data.unit}`;
            let locationBlock = data.systemType === "Water Meter" ? `LOCATION DETAILS\n--------------------------------\nAt Street: ${data.locStreet}\nWithin 20ft: ${data.loc20}\nBeyond 20ft: ${data.locBeyond}\n\n` : '';
            let mapLink = data.gps ? `https://www.google.com/maps/search/?api=1&query=${data.gps}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.address)}`;
            const body = `SHUTOFF REPORT\n--------------------------------\nUNIT: ${data.unit}\nTYPE: ${data.systemType}\nADDRESS: ${data.address}\nDATE/TIME: ${data.dateTime.replace('T', ' ')}\nFIRE WATCH ISSUED: ${data.fireWatch}\n\n${locationBlock}MAP LINK: ${mapLink}\n\nDAMAGE REPORT\n--------------------------------\nDamaged: ${data.damage}\n${data.damage === 'Yes' ? `Description: ${data.notes}` : ''}\n\nLogged via Denton Fire Dept Water Shutoff Survey`;
            window.lastEmailData = { recipient, subject, body };
            window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            setTimeout(() => document.getElementById('email-fallback-modal').classList.remove('hidden'), 1000);
        }

        window.copyEmailToClipboard = function() { const data = window.lastEmailData; if (!data) return; const fullText = `TO: ${data.recipient}\nSUBJECT: ${data.subject}\n\n${data.body}`; navigator.clipboard.writeText(fullText).then(() => { showToast("‚úÖ Email copied!"); document.getElementById('email-fallback-modal').classList.add('hidden'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = fullText; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showToast("‚úÖ Email copied!"); document.getElementById('email-fallback-modal').classList.add('hidden'); }); }
        window.closeEmailFallback = function() { document.getElementById('email-fallback-modal').classList.add('hidden'); }
        function showToast(msg) { const toast = document.getElementById('clipboard-toast'); toast.innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }

        window.toggleQrModal = function() { const modal = document.getElementById('qr-modal'); modal.classList.toggle('hidden'); if (!modal.classList.contains('hidden')) document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('https://dentonfire.github.io/Water-Shutoff/water_shutoff.html')}`; }
        window.closeFireWatchModal = function() { document.getElementById('firewatch-modal').classList.add('hidden'); }

        window.getGPS = function() {
            const btn = document.getElementById('gps-btn'); const statusDiv = document.getElementById('gps-status');
            btn.innerHTML = "<span>‚è≥</span> Requesting...";
            if (!navigator.geolocation) { alert("Geolocation not supported."); btn.innerHTML = "<span>üìç</span> Get My Location"; return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                document.getElementById('gps-coords').value = `${lat},${lon}`;
                statusDiv.classList.remove('hidden'); statusDiv.className = "text-xs text-green-600 mt-1";
                statusDiv.innerText = `‚úì ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`).then(r => r.json()).then(d => { if (d.features && d.features.length) { const p = d.features[0].properties; const addr = [p.name, p.housenumber, p.street, p.city].filter(Boolean).join(', '); if(addr) document.getElementById('address').value = addr; } });
                btn.innerHTML = "<span>üìç</span> Update Location";
            }, (error) => {
                btn.innerHTML = "<span>üìç</span> Get My Location";
                statusDiv.classList.remove('hidden'); statusDiv.className = "text-xs text-red-600 mt-1";
                switch(error.code) { case error.PERMISSION_DENIED: statusDiv.innerText = "‚úó Permission denied. Enable in browser settings."; break; case error.POSITION_UNAVAILABLE: statusDiv.innerText = "‚úó Location unavailable."; break; case error.TIMEOUT: statusDiv.innerText = "‚úó Request timed out."; break; default: statusDiv.innerText = "‚úó Unable to get location."; }
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
        }

        window.toggleFields = function() { const type = document.querySelector('input[name="systemType"]:checked').value; const detailsDiv = document.getElementById('location-details'); const info = document.getElementById('routing-info'); if (type === 'Water Meter') { detailsDiv.classList.remove('hidden'); info.innerHTML = `Routes to: <strong>Water Distribution Dept.</strong>`; } else { detailsDiv.classList.add('hidden'); info.innerHTML = `Routes to: <strong>Fire Prevention Division</strong>`; } }
        window.toggleDamage = function() { const val = document.querySelector('input[name="damage"]:checked').value; const div = document.getElementById('damage-details'); if (val === 'Yes') div.classList.remove('hidden'); else { div.classList.add('hidden'); document.getElementById('notes').value = ''; } }

        let debounceTimer;
        window.handleAddressInput = function(e) { const query = e.target.value; const resDiv = document.getElementById('address-results'); resDiv.innerHTML = ''; resDiv.classList.add('hidden'); clearTimeout(debounceTimer); if (query.length < 3) return; debounceTimer = setTimeout(async () => { try { const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lat=33.2148&lon=-97.1331&limit=5`); if(!r.ok) return; const d = await r.json(); if(d.features && d.features.length) { resDiv.classList.remove('hidden'); d.features.forEach(f => { const p = f.properties; const name = [p.name, p.housenumber, p.street, p.city].filter(Boolean).join(', '); const div = document.createElement('div'); div.className = "p-3 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100"; div.innerText = name; div.onclick = () => { document.getElementById('address').value = name; resDiv.classList.add('hidden'); if(f.geometry?.coordinates) { const [lon, lat] = f.geometry.coordinates; document.getElementById('gps-coords').value = `${lat},${lon}`; document.getElementById('gps-status').classList.remove('hidden'); document.getElementById('gps-status').className = "text-xs text-green-600 mt-1"; document.getElementById('gps-status').innerText = "‚úì Location Auto-filled"; } }; resDiv.appendChild(div); }); } } catch(e) {} }, 300); }
    </script>
</head>
<body class="relative">
    <div id="offline-banner">‚ö†Ô∏è Offline. Reports saved locally and will sync when connection is restored.</div>
    <div id="clipboard-toast"></div>
    <div id="auth-loading" class="fixed inset-0 z-[10000] flex items-center justify-center transition-opacity duration-500 px-4">
        <div class="bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 scan-line-gradient animate-scan"></div>
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-16 mx-auto mb-4">
            <h2 class="text-2xl font-black text-white mb-1 uppercase">Verifying Access</h2>
            <p class="text-blue-200 text-xs mb-6 uppercase">Water Shutoff Survey</p>
            <div class="text-white/70 text-sm animate-pulse">Connecting to secure server...</div>
            <div class="mt-6 flex items-center justify-center gap-2 opacity-60"><div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div><p class="text-[10px] font-mono uppercase text-white">CHECKING CREDENTIALS</p></div>
        </div>
    </div>
    <div id="main-content" class="opacity-0 transition-opacity duration-300">
        <div class="paper-doc">
            <div class="text-center border-b-4 border-yellow pb-6 mb-6 mt-4"><img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" class="h-20 mx-auto mb-3"><h1 class="text-2xl font-black text-navy uppercase tracking-wide">Water Shutoff Survey</h1><p class="text-gray-600 text-sm mt-2">Log Sprinkler or Water Meter shutoffs for Fire Prevention & Water Dept.</p></div>
            <form id="shutoffForm" class="space-y-8">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">1. Unit Identification</h2><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Unit <span class="text-red">*</span></label><select id="unit-select" onchange="handleUnitChange()" class="w-full border border-gray-300 rounded p-2 bg-white font-bold text-navy"></select><div id="custom-unit-div" class="hidden mt-3"><label class="block text-xs font-bold text-blue-600 uppercase mb-1">Enter New Unit Name:</label><input type="text" id="custom-unit-input" class="w-full border-2 border-blue-300 rounded p-2 uppercase placeholder-gray-400" placeholder="Ex: E9, SQ1"></div></div></div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">2. Location & Time</h2><div class="space-y-4"><div id="address-container" class="relative"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Shutoff Address <span class="text-red">*</span></label><input type="text" id="address" oninput="handleAddressInput(event)" class="w-full border border-gray-300 rounded p-2" placeholder="123 Example St, Denton, TX" autocomplete="off"><div id="address-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b shadow-lg hidden mt-0 max-h-60 overflow-y-auto"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date/Time <span class="text-red">*</span></label><input type="datetime-local" id="datetime" class="w-full border border-gray-300 rounded p-2"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">GPS Coords (Optional)</label><button type="button" id="gps-btn" onclick="getGPS()" class="w-full bg-white border border-navy text-navy font-bold py-2 rounded hover:bg-navy hover:text-white transition text-xs flex items-center justify-center gap-2"><span>üìç</span> Get My Location</button><input type="hidden" id="gps-coords"><div id="gps-status" class="text-xs text-green-600 mt-1 hidden">‚úì Location Acquired</div></div></div></div></div>
                <div><h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">3. System Information</h2><div class="grid grid-cols-2 gap-4"><label class="cursor-pointer"><input type="radio" name="systemType" value="Water Meter" class="hidden" onchange="toggleFields()"><div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-navy transition font-bold text-gray-600">üíß Water Meter</div></label><label class="cursor-pointer"><input type="radio" name="systemType" value="Sprinkler System" class="hidden" onchange="toggleFields()"><div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-navy transition font-bold text-gray-600">üßØ Sprinkler System</div></label></div></div>
                <div id="location-details" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100"><h3 class="text-navy font-bold text-md mb-3">Location Relative to Address</h3><div class="space-y-4"><div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">At the street:</span><select id="loc-street" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha (Front)</option><option value="Bravo">Bravo (Left)</option><option value="Charlie">Charlie (Rear)</option><option value="Delta">Delta (Right)</option></select></div><div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">Within 20ft:</span><select id="loc-20ft" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha</option><option value="Bravo">Bravo</option><option value="Charlie">Charlie</option><option value="Delta">Delta</option></select></div><div class="flex items-center justify-between"><span class="text-sm font-bold text-gray-700 w-1/3">Beyond 20ft:</span><select id="loc-beyond" class="w-2/3 border border-gray-300 rounded p-1 text-sm"><option value="N/A">N/A</option><option value="Alpha">Alpha</option><option value="Bravo">Bravo</option><option value="Charlie">Charlie</option><option value="Delta">Delta</option></select></div></div></div>
                <div><h2 class="text-navy font-bold text-lg mb-4 border-b border-gray-300 pb-2">4. Damage Report</h2><div class="mb-4"><span class="block text-sm font-bold text-gray-700 mb-2">Was the system damaged?</span><div class="flex gap-6"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="damage" value="Yes" class="w-4 h-4" onchange="toggleDamage()"><span class="text-sm">Yes</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="damage" value="No" class="w-4 h-4" checked onchange="toggleDamage()"><span class="text-sm">No</span></label></div></div><div id="damage-details" class="hidden"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description of Damage <span class="text-red">*</span></label><textarea id="notes" rows="3" class="w-full border border-gray-300 rounded p-2" placeholder="Please describe the damage..."></textarea></div></div>
                <div class="pt-6"><div class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4"><label class="flex items-center gap-2 cursor-pointer bg-gray-50 px-4 py-3 rounded-lg border border-gray-200 shadow-sm hover:bg-gray-100 transition select-none w-full sm:w-auto justify-center"><input type="checkbox" id="fire-watch-check" class="w-5 h-5 rounded cursor-pointer"><span class="text-sm font-bold text-navy">Fire Watch Issued</span></label><a href="https://dentonfire.github.io/Fire-Watch/" target="_blank" class="bg-red text-white px-4 py-3 rounded-lg shadow hover:bg-red-700 text-xs font-bold uppercase flex items-center justify-center gap-2 w-full sm:w-auto transition"><span class="text-lg">üî•</span> Fire Watch</a></div><button type="button" id="submit-btn" onclick="initiateSubmit()" class="w-full bg-navy text-white font-bold py-4 rounded-lg hover:bg-gray-800 transition shadow-lg flex items-center justify-center gap-2 text-lg">üì§ Submit & Generate Email</button><p id="routing-info" class="text-center text-xs text-gray-500 mt-2">Submitting logs data to the map and opens your email client.</p></div>
            </form>
        </div>
    </div>
    <div class="fixed bottom-6 right-6 z-50"><button onclick="toggleQrModal()" class="bg-navy/90 hover:bg-navy text-white rounded-full w-14 h-14 flex items-center justify-center shadow-2xl border-2 border-white/20 transition-all hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" /></svg></button></div>
    <div id="qr-modal" class="fixed inset-0 z-[60] hidden"><div class="fixed inset-0 bg-navy/80 backdrop-blur-sm" onclick="toggleQrModal()"></div><div class="fixed inset-0 z-10 flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center"><div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-navy/10 mb-4"><svg class="h-6 w-6 text-navy" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5Z" /></svg></div><h3 class="text-base font-semibold text-gray-900 mb-2">Scan for Mobile Access</h3><p class="text-sm text-gray-500 mb-4">Scan this code to open on your mobile device.</p><div class="flex justify-center p-2 border border-gray-100 rounded bg-gray-50"><img id="qr-image" src="" alt="QR Code" class="w-48 h-48"></div><button type="button" onclick="toggleQrModal()" class="mt-4 w-full rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Close</button></div></div></div>
    <div id="firewatch-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-navy/90 hidden backdrop-blur-sm"><div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 text-center border-t-8 border-red modal-fade-in"><div class="w-12 h-12 bg-red-100 text-red rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-2xl">üî•</span></div><h3 class="text-navy font-black text-xl mb-1">FIRE WATCH REMINDER</h3><p class="text-gray-600 text-sm mb-6">If the suppression system is down, have you issued a <strong>Fire Watch</strong>?</p><div class="space-y-3"><a href="https://dentonfire.github.io/Fire-Watch/" target="_blank" class="block w-full bg-red text-white font-bold py-3 rounded hover:bg-red-700 transition flex items-center justify-center gap-2"><span>üìÑ</span> Open Guidelines</a><button onclick="finalSubmit()" class="block w-full bg-gray-100 text-navy font-bold py-3 rounded hover:bg-gray-200 transition">Proceed to Submit ‚Üí</button></div><button onclick="closeFireWatchModal()" class="mt-4 text-xs text-gray-400 hover:text-gray-600">Cancel</button></div></div>
    <div id="email-fallback-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-navy/90 hidden backdrop-blur-sm"><div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 text-center modal-fade-in"><div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div><h3 class="text-navy font-black text-lg mb-2">Email Not Opening?</h3><p class="text-gray-600 text-sm mb-4">Copy the report to your clipboard and paste it manually.</p><div class="space-y-3"><button onclick="copyEmailToClipboard()" class="block w-full bg-navy text-white font-bold py-3 rounded hover:bg-gray-800 transition flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg> Copy to Clipboard</button><button onclick="closeEmailFallback()" class="block w-full bg-gray-100 text-gray-600 font-bold py-3 rounded hover:bg-gray-200 transition">Close</button></div></div></div>
</body>
</html>
